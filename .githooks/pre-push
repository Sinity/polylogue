#!/usr/bin/env bash
# Pre-push hook to check for messy commits before pushing
# Install with: git config core.hooksPath .githooks

# ANSI color codes
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Get the branch being pushed
current_branch=$(git symbolic-ref --short HEAD)

# Skip checks for main/master
if [[ "$current_branch" == "main" || "$current_branch" == "master" ]]; then
    exit 0
fi

# Get commits that would be pushed
commits=$(git log --pretty=format:"%h %s" @{upstream}..HEAD 2>/dev/null)

# If no upstream, compare with origin/main
if [ -z "$commits" ]; then
    commits=$(git log --pretty=format:"%h %s" origin/main..HEAD 2>/dev/null)
fi

# If still no commits, skip check
if [ -z "$commits" ]; then
    exit 0
fi

# Check for problematic commit messages
messy_commits=$(echo "$commits" | grep -iE "(WIP|wip|TODO|todo|fixup|squash|oops|temp|temporary|debug|test commit|asdf|foo|bar)")

if [ -n "$messy_commits" ]; then
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${RED}⚠️  WARNING: Messy commits detected!${NC}"
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -e "${YELLOW}The following commits should be cleaned up:${NC}"
    echo ""
    echo "$messy_commits" | while read -r line; do
        echo -e "  ${RED}✗${NC} $line"
    done
    echo ""
    echo -e "${YELLOW}This project uses merge commits with clean feature branches.${NC}"
    echo ""
    echo -e "${GREEN}To clean up your commits:${NC}"
    echo ""
    echo "  git rebase -i main"
    echo ""
    echo -e "Then use ${GREEN}squash${NC} or ${GREEN}fixup${NC} to combine messy commits."
    echo ""
    echo -e "See ${GREEN}.github/CONTRIBUTING.md${NC} for detailed instructions."
    echo ""
    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    read -p "Push anyway? [y/N] " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${RED}Push cancelled.${NC}"
        exit 1
    fi
fi

# Check for non-conventional commit format
non_conventional=$(echo "$commits" | grep -vE "^[a-f0-9]+ (feat|fix|docs|style|refactor|test|chore|perf)(\(.+\))?: ")

if [ -n "$non_conventional" ]; then
    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${YELLOW}ℹ️  Some commits don't follow conventional format${NC}"
    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo "$non_conventional" | while read -r line; do
        echo -e "  ${YELLOW}⚠${NC} $line"
    done
    echo ""
    echo -e "${GREEN}Conventional format:${NC} type: description"
    echo -e "${GREEN}Types:${NC} feat, fix, docs, style, refactor, test, chore, perf"
    echo ""
    echo -e "${GREEN}Example:${NC} feat: add progress bars to sync operations"
    echo ""
    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
fi

exit 0
